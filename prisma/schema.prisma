generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Equipment {
  id           String             @id @default(cuid())
  userId       String
  name         String
  type         EquipmentType
  manufacturer String?
  model        String?
  notes        String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  findings     FindingEquipment[]

  @@index([type])
  @@index([userId])
}

model FavoriteLocation {
  id        String   @id @default(cuid())
  userId    String
  name      String
  latitude  Float
  longitude Float
  notes     String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model FeatureRequest {
  id          String        @id @default(cuid())
  userId      String
  title       String
  description String
  status      FeatureStatus @default(NEW)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  category    String        @default("Ostatní")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes       FeatureVote[]

  @@index([category])
  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model FeatureVote {
  id        String         @id @default(cuid())
  userId    String
  featureId String
  createdAt DateTime       @default(now())
  feature   FeatureRequest @relation(fields: [featureId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureId])
  @@index([featureId])
  @@index([userId])
}

model Finding {
  id                String             @id @default(cuid())
  userId            String
  title             String
  latitude          Float
  longitude         Float
  date              DateTime
  description       String
  category          String
  
  // Typ nálezu (wizard)
  findingType       String             @default("GENERAL") // COIN, STAMP, MILITARY, TERRAIN, GENERAL
  
  // Existující rozšířená pole
  condition         String?
  depth             Float?
  locationName      String?
  historicalContext String?
  material          String?
  
  // Univerzální pole (identifikace)
  period            String?            // Období / datace (text)
  periodFrom        Int?               // Rok od
  periodTo          Int?               // Rok do
  dimensions        String?            // Rozměry
  weight            Float?             // Hmotnost v gramech
  
  // Specifická pole - COIN (numismatika)
  denomination      String?            // Nominál
  mintYear          Int?               // Rok ražby
  mint              String?            // Mincovna
  catalogNumber     String?            // Katalogové číslo
  grade             String?            // Kvalita / grading
  
  // Specifická pole - STAMP (filatelie)
  stampYear         Int?               // Rok vydání
  stampCatalogNumber String?           // Katalogové číslo (filatelie)
  perforation       String?            // Perforace / zoubkování
  printType         String?            // Typ tisku
  cancellation      String?            // Razítko
  
  // Specifická pole - MILITARY (militárie)
  army              String?            // Armáda / země
  conflict          String?            // Konflikt / období
  unit              String?            // Jednotka
  authenticity      String?            // Autenticita
  
  // Specifická pole - TERRAIN (detektoráři)
  detectorSignal    String?            // Signál detektoru
  landType          String?            // Typ pozemku
  soilConditions    String?            // Půdní podmínky
  
  // Provenience
  origin            String?            // Původ / země
  acquisitionMethod String?            // Způsob získání
  estimatedValue    String?            // Odhadovaná hodnota
  storageLocation   String?            // Úložné místo
  
  // Systémová pole
  visibility        FindingVisibility  @default(PRIVATE)
  isPublic          Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // Relace
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  images            FindingImage[]
  equipment         FindingEquipment[]
  customFieldValues CustomFieldValue[]

  @@index([category])
  @@index([date])
  @@index([visibility])
  @@index([isPublic])
  @@index([userId])
  @@index([findingType])
}

enum FindingVisibility {
  PRIVATE
  ANONYMOUS
  PUBLIC
}

model FindingEquipment {
  id          String    @id @default(cuid())
  findingId   String
  equipmentId String
  createdAt   DateTime  @default(now())
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  finding     Finding   @relation(fields: [findingId], references: [id], onDelete: Cascade)

  @@unique([findingId, equipmentId])
  @@index([equipmentId])
  @@index([findingId])
}

model FindingImage {
  id           String   @id @default(cuid())
  findingId    String
  originalUrl  String
  thumbnailUrl String
  mediumUrl    String
  order        Int      @default(0)
  filename     String
  filesize     Int
  createdAt    DateTime @default(now())
  finding      Finding  @relation(fields: [findingId], references: [id], onDelete: Cascade)

  @@index([findingId])
  @@index([findingId, order])
}

model SocialLink {
  id        String   @id @default(cuid())
  userId    String
  platform  String
  url       String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MapSetup {
  id        String   @id @default(cuid())
  userId    String
  name      String
  config    Json
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Sector {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  geometry    Json     // GeoJSON Polygon
  stripWidth  Float    @default(3) // Šířka pásu v metrech
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tracks      Track[]

  @@index([userId])
  @@index([createdAt])
}

model Track {
  id        String      @id @default(cuid())
  sectorId  String
  geometry  Json        // GeoJSON LineString
  status    TrackStatus @default(PENDING)
  order     Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  sector    Sector      @relation(fields: [sectorId], references: [id], onDelete: Cascade)

  @@index([sectorId])
  @@index([sectorId, order])
}

enum TrackStatus {
  PENDING      // Šedá - neprošlé
  IN_PROGRESS  // Modrá - probíhá
  COMPLETED    // Zelená - hotové
  SKIPPED      // Oranžová - přeskočené
}

model User {
  id                  String             @id
  email               String             @unique
  nickname            String?
  bio                 String?
  avatarUrl           String?
  location            String?
  contact             String?
  experience          String?
  collectorTypes      CollectorType[]    @default([])
  onboardingCompleted Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  equipment           Equipment[]
  favoriteLocations   FavoriteLocation[]
  featureRequests     FeatureRequest[]
  featureVotes        FeatureVote[]
  findings            Finding[]
  mapSetups           MapSetup[]
  sectors             Sector[]
  socialLinks         SocialLink[]
  customFields        CustomField[]

  @@index([email])
}

// Vlastní pole definovaná uživatelem
model CustomField {
  id        String             @id @default(cuid())
  userId    String
  name      String             // Název pole
  fieldType String             // text, number, date, select
  options   String?            // Pro select: "Ano,Ne,Možná" (čárkou oddělené)
  icon      String?            // Lucide icon name
  order     Int                @default(0)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  values    CustomFieldValue[]

  @@index([userId])
  @@index([userId, order])
}

// Hodnota vlastního pole pro konkrétní nález
model CustomFieldValue {
  id            String      @id @default(cuid())
  findingId     String
  customFieldId String
  value         String
  createdAt     DateTime    @default(now())
  finding       Finding     @relation(fields: [findingId], references: [id], onDelete: Cascade)
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([findingId, customFieldId])
  @@index([findingId])
  @@index([customFieldId])
}

enum EquipmentType {
  DETECTOR
  GPS
  MAGNIFIER   // Lupa/mikroskop (numismatika, filatelie)
  CATALOG     // Katalogy
  STORAGE     // Úložné systémy (alba, boxy)
  OTHER
}

enum CollectorType {
  NUMISMATIST   // Mince + bankovky
  PHILATELIST   // Poštovní známky
  MILITARIA     // Militárie a legionáře
  DETECTORIST   // Detektoráři
}

enum FeatureStatus {
  NEW
  PLANNED
  IN_PROGRESS
  DONE
}
